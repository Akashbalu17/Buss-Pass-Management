<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check Application Status</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background:
        linear-gradient(rgba(16, 30, 44, 0.68), rgba(16, 30, 44, 0.8)),
        url('/images/status-bus-different.jpg?v=3');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-height: 100vh;
    }

    .status-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(4px);
      border-radius: 14px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="/">Bus Pass Status</a>
      <a href="/" class="btn btn-light btn-sm">Home</a>
    </div>
  </nav>

  <main class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-7">
        <div class="card status-card border-0 shadow-sm">
          <div class="card-body p-4 p-md-5">
            <h2 class="h4 mb-4">Check Your Application</h2>
            <div class="mb-3">
              <label for="applicationNo" class="form-label">Application Number</label>
              <input id="applicationNo" class="form-control" type="text" maxlength="8" placeholder="Enter 8-digit application number" />
            </div>
            <button id="checkBtn" class="btn btn-success w-100">Check Status</button>
            <div id="errorBox" class="alert alert-danger mt-3 d-none"></div>

            <section id="resultCard" class="mt-4 d-none">
              <hr />
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Application No</span>
                <strong id="resultAppNo">-</strong>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Student Name</span>
                <strong id="resultName">-</strong>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">Status</span>
                <span id="resultStatusBadge" class="badge">-</span>
              </div>
              <div id="statusNote" class="alert mb-3"></div>
              <div id="reasonBox" class="alert alert-danger d-none"></div>

              <div class="d-grid gap-2">
                <a id="viewIdBtn" class="btn btn-success d-none" target="_blank">View Bus Pass ID</a>
                <a id="downloadIdBtn" class="btn btn-outline-success d-none">Download ID PDF</a>
                <a id="viewTicketBtn" class="btn btn-info text-white d-none" target="_blank">View Ticket</a>
                <a id="downloadTicketBtn" class="btn btn-outline-info d-none">Download Ticket PDF</a>
                <button id="resetBtn" class="btn btn-secondary">Check Another Application</button>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const applicationNoInput = document.getElementById("applicationNo");
    const checkBtn = document.getElementById("checkBtn");
    const resetBtn = document.getElementById("resetBtn");
    const errorBox = document.getElementById("errorBox");
    const resultCard = document.getElementById("resultCard");
    const resultAppNo = document.getElementById("resultAppNo");
    const resultName = document.getElementById("resultName");
    const resultStatusBadge = document.getElementById("resultStatusBadge");
    const statusNote = document.getElementById("statusNote");
    const reasonBox = document.getElementById("reasonBox");
    const viewIdBtn = document.getElementById("viewIdBtn");
    const downloadIdBtn = document.getElementById("downloadIdBtn");
    const viewTicketBtn = document.getElementById("viewTicketBtn");
    const downloadTicketBtn = document.getElementById("downloadTicketBtn");

    applicationNoInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") checkStatus();
    });
    checkBtn.addEventListener("click", checkStatus);
    resetBtn.addEventListener("click", resetForm);

    function showError(message) {
      errorBox.textContent = message;
      errorBox.classList.remove("d-none");
      resultCard.classList.add("d-none");
    }

    function clearError() {
      errorBox.classList.add("d-none");
      errorBox.textContent = "";
    }

    async function checkStatus() {
      const appNo = applicationNoInput.value.trim();
      if (!/^\d{8}$/.test(appNo)) {
        showError("Please enter a valid 8-digit application number.");
        return;
      }

      clearError();

      try {
        const response = await fetch(`/check-status/${appNo}`);
        const data = await response.json();
        if (!response.ok || data.error) {
          showError(data.error || "Unable to fetch status.");
          return;
        }
        renderResult(data);
      } catch (err) {
        showError("Network error. Please try again.");
      }
    }

    function renderResult(data) {
      resultAppNo.textContent = data.applicationNo || "-";
      resultName.textContent = data.studentName || "-";

      const status = data.status || "Pending";
      if (status === "Approved") {
        resultStatusBadge.className = "badge bg-success";
        resultStatusBadge.textContent = "Approved";
        statusNote.className = "alert alert-success mb-3";
        statusNote.textContent = "Your application is approved. You can now view and download both ID card and ticket.";
        reasonBox.classList.add("d-none");
        viewIdBtn.href = `/bus-pass-id/${encodeURIComponent(data.applicationNo)}`;
        downloadIdBtn.href = `/id/download/${encodeURIComponent(data.applicationNo)}`;
        viewIdBtn.classList.remove("d-none");
        downloadIdBtn.classList.remove("d-none");
        viewTicketBtn.href = `/bus-ticket/${encodeURIComponent(data.applicationNo)}`;
        downloadTicketBtn.href = `/ticket/download/${encodeURIComponent(data.applicationNo)}`;
        viewTicketBtn.classList.remove("d-none");
        downloadTicketBtn.classList.remove("d-none");
      } else if (status === "Rejected") {
        resultStatusBadge.className = "badge bg-danger";
        resultStatusBadge.textContent = "Rejected";
        statusNote.className = "alert alert-danger mb-3";
        statusNote.textContent = "Your application was rejected.";
        viewIdBtn.classList.add("d-none");
        downloadIdBtn.classList.add("d-none");
        viewTicketBtn.classList.add("d-none");
        downloadTicketBtn.classList.add("d-none");
        if (data.rejectionReason) {
          reasonBox.textContent = `Reason: ${data.rejectionReason}`;
          reasonBox.classList.remove("d-none");
        } else {
          reasonBox.classList.add("d-none");
        }
      } else {
        resultStatusBadge.className = "badge bg-warning text-dark";
        resultStatusBadge.textContent = "Pending";
        statusNote.className = "alert alert-warning mb-3";
        statusNote.textContent = "Your application is under review.";
        reasonBox.classList.add("d-none");
        viewIdBtn.classList.add("d-none");
        downloadIdBtn.classList.add("d-none");
        viewTicketBtn.classList.add("d-none");
        downloadTicketBtn.classList.add("d-none");
      }

      resultCard.classList.remove("d-none");
    }

    function resetForm() {
      applicationNoInput.value = "";
      clearError();
      resultCard.classList.add("d-none");
      applicationNoInput.focus();
    }

    applicationNoInput.focus();
  </script>
</body>
</html>
